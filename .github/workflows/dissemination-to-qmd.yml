name: Dissemination Issue to QMD

on:
  issues:
    types: [opened, edited]


jobs:
  create-qmd-from-issue:
    if: |
      contains(github.event.issue.labels.*.name, 'dissemination')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install R Dependencies
        run: |
          Rscript -e 'install.packages(c("rmarkdown", "knitr", "data.table", "knitcitations", "stringr", "glue"))'

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Extract issue fields and create QMD
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Extract fields from the issue body (YAML form uses ### headers)
          TITLE=$(echo "$ISSUE_BODY" | awk '/^### Title$/{flag=1;next}/^### /{flag=0}flag' | sed '/^[[:space:]]*$/d' | xargs)
          SUMMARY=$(echo "$ISSUE_BODY" | awk '/^### Summary$/{flag=1;next}/^### /{flag=0}flag' | sed '/^[[:space:]]*$/d' | xargs)
          CONTENT=$(echo "$ISSUE_BODY" | awk '/^### Main Content$/{flag=1;next}/^### /{flag=0}flag')
          AUTHOR=$(echo "$ISSUE_BODY" | awk '/^### Author$/{flag=1;next}/^### /{flag=0}flag' | sed '/^[[:space:]]*$/d' | xargs)

          # Fallbacks if fields are empty
          [ -z "$TITLE" ] && TITLE="$ISSUE_TITLE"
          [ -z "$AUTHOR" ] && AUTHOR="Unknown"

          # Slugify the title for folder name
          SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^[-]*\|[-]*$//g')
          DATE=$(date +%Y-%m-%d)
          POST_DIR="post/$DATE-$SLUG"
          mkdir -p "$POST_DIR"

          # Create the QMD file with proper YAML front matter
          QMD_FILE="$POST_DIR/$SLUG.qmd"
          SAFE_TITLE=$(printf '%s' "$TITLE" | sed 's/"/\\"/g')
          SAFE_SUMMARY=$(printf '%s' "$SUMMARY" | sed 's/"/\\"/g')
          SAFE_AUTHOR=$(printf '%s' "$AUTHOR" | sed 's/"/\\"/g')
          {
            printf '%s\n' '---'
            printf 'title: "%s"\n' "$SAFE_TITLE"
            printf '%s\n' 'description: |'
            printf '  %s\n' "$SAFE_SUMMARY"
            printf '%s\n' 'author:'
            printf '  - name: "%s"\n' "$SAFE_AUTHOR"
            printf 'date: %s\n' "$DATE"
            printf '%s\n\n' '---'
            printf '%s\n' "$CONTENT"
          } > "$QMD_FILE"

          echo "Created $QMD_FILE"


      - name: Commit and push QMD
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add post/
          git commit -m "Add dissemination post from issue #${ISSUE_NUMBER}" || echo "No changes to commit"
          git push

      - name: Render site with Quarto
        run: quarto render

      - name: Commit and push rendered site
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/
          git commit -m "Render site for issue #${ISSUE_NUMBER}" || echo "No changes to commit"
          git push

      - name: Close the issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            })

name: Dissemination Issue to QMD

on:
  issues:
    types: [opened, edited]


jobs:
  create-qmd-from-issue:
    if: |
      contains(github.event.issue.labels.*.name, 'dissemination')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Extract issue fields and create QMD
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Extract fields from the issue body (YAML form uses ### headers)
          TITLE=$(echo "$ISSUE_BODY" | awk '/^### Title$/{flag=1;next}/^### /{flag=0}flag' | sed '/^[[:space:]]*$/d' | xargs)
          SUMMARY=$(echo "$ISSUE_BODY" | awk '/^### Summary$/{flag=1;next}/^### /{flag=0}flag' | sed '/^[[:space:]]*$/d' | xargs)
          CONTENT=$(echo "$ISSUE_BODY" | awk '/^### Main Content$/{flag=1;next}/^### /{flag=0}flag')
          AUTHOR=$(echo "$ISSUE_BODY" | awk '/^### Author$/{flag=1;next}/^### /{flag=0}flag' | sed '/^[[:space:]]*$/d' | xargs)

          # Fallbacks if fields are empty
          [ -z "$TITLE" ] && TITLE="$ISSUE_TITLE"
          [ -z "$AUTHOR" ] && AUTHOR="Unknown"

          # Slugify the title for folder name
          SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^[-]*\|[-]*$//g')
          DATE=$(date +%Y-%m-%d)
          POST_DIR="post/$DATE-$SLUG"
          mkdir -p "$POST_DIR"

          # Create the QMD file with proper YAML front matter
          QMD_FILE="$POST_DIR/$SLUG.qmd"
          cat > "$QMD_FILE" << 'QMDEOF'
---
title: "TITLE_PLACEHOLDER"
description: |
  SUMMARY_PLACEHOLDER
author:
  - name: "AUTHOR_PLACEHOLDER"
date: DATE_PLACEHOLDER
---

CONTENT_PLACEHOLDER
QMDEOF

          # Replace placeholders with actual values
          sed -i "s|TITLE_PLACEHOLDER|$TITLE|g" "$QMD_FILE"
          sed -i "s|SUMMARY_PLACEHOLDER|$SUMMARY|g" "$QMD_FILE"
          sed -i "s|AUTHOR_PLACEHOLDER|$AUTHOR|g" "$QMD_FILE"
          sed -i "s|DATE_PLACEHOLDER|$DATE|g" "$QMD_FILE"
          sed -i "s|CONTENT_PLACEHOLDER|$CONTENT|g" "$QMD_FILE"

          echo "Created $QMD_FILE"


      - name: Commit and push QMD
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add post/
          git commit -m "Add dissemination post from issue #${ISSUE_NUMBER}" || echo "No changes to commit"
          git push

      - name: Close the issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            })

      - name: Commit and push QMD
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add post/
          git commit -m "Add dissemination post from issue #${ISSUE_NUMBER}" || echo "No changes to commit"
          git push
